<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Local KOM/QOM Leaderboards</title>

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
        integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Leaflet CSS/JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        /* Ensure map has a height */
        #map {
            height: 420px;
        }

        /* Smooth scrolling for anchor-like interactions */
        html {
            scroll-behavior: smooth;
        }

        /* Dark mode styles */
        .dark {
            color-scheme: dark;
        }

        .dark body {
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .dark .bg-white {
            background-color: #1e293b;
        }

        .dark .border-slate-200 {
            border-color: #334155;
        }

        .dark .text-slate-800 {
            color: #e2e8f0;
        }

        .dark .text-slate-600 {
            color: #94a3b8;
        }

        .dark .text-slate-500 {
            color: #64748b;
        }

        .dark .text-slate-400 {
            color: #94a3b8;
        }

        .dark .border-slate-300 {
            border-color: #475569;
        }

        .dark .bg-slate-50 {
            background-color: #334155;
        }

        .dark .bg-slate-100 {
            background-color: #475569;
        }

        .dark .backdrop-blur {
            background-color: rgba(15, 23, 42, 0.8);
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800">
    <header class="sticky top-0 z-30 backdrop-blur bg-white/80 border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <span
                    class="inline-flex h-10 w-10 items-center justify-center rounded-lg bg-orange-500 text-white text-xl font-bold shadow"><i
                        class="fa-solid fa-person-biking"></i></span>
                <div>
                    <h1 class="text-xl sm:text-2xl font-semibold">Chipotle Leaderboards</h1>
                    <p class="text-xs sm:text-sm text-slate-500">Norfolk area's Strava segments and top times
                    </p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button id="darkModeToggle"
                    class="inline-flex items-center gap-2 text-sm text-slate-600 hover:text-orange-600">
                    <i class="fa-solid fa-moon dark:hidden"></i>
                    <i class="fa-solid fa-sun hidden dark:inline"></i>
                    <span class="hidden sm:inline">Dark mode</span>
                </button>
                <a href="https://www.strava.com"
                    class="hidden sm:inline-flex items-center gap-2 text-sm text-slate-600 hover:text-orange-600"
                    target="_blank" rel="noopener">
                    <i class="fa-brands fa-strava"></i>
                    <span>Powered by Strava segments</span>
                </a>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Controls -->
        <section class="mb-6">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
                <div class="lg:col-span-8">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <label class="relative flex-1">
                            <input id="searchInput" type="search" placeholder="Search segments or riders..."
                                class="w-full rounded-lg border border-slate-300 bg-white px-4 py-2.5 pr-10 shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500" />
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400"><i
                                    class="fa-solid fa-magnifying-glass"></i></span>
                        </label>

                    </div>
                </div>
                <div class="lg:col-span-4">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <div class="flex gap-2">
                            <button id="komBtn"
                                class="inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-3 py-2.5 text-sm shadow-sm hover:bg-slate-50">
                                <i class="fa-solid fa-chess-king"></i>
                                KOM
                            </button>
                            <button id="qomBtn"
                                class="inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-3 py-2.5 text-sm shadow-sm hover:bg-slate-50">
                                <i class="fa-solid fa-chess-queen"></i>
                                QOM
                            </button>
                        </div>
                        <label class="flex-1">
                            <select id="sortSelect"
                                class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2.5 shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                                <option value="name-asc">Sort: Segment name (A→Z)</option>
                                <option value="distance-asc">Sort: Distance (short→long)</option>
                                <option value="distance-desc">Sort: Distance (long→short)</option>
                                <option value="besttime-asc">Sort: Fastest best time</option>
                                <option value="leaderboard-desc">Sort: Most leaderboard entries</option>
                            </select>
                        </label>

                        <button id="woodburyFilterBtn"
                            class="inline-flex items-center justify-center gap-2 rounded-lg border border-slate-300 bg-white px-3 py-2.5 text-sm shadow-sm hover:bg-slate-50">
                            <i class="fa-solid fa-hand-back-fist"></i>
                            Woodbury
                        </button>
                        <button id="resetBtn"
                            class="inline-flex items-center justify-center gap-2 rounded-lg border border-slate-300 bg-white px-3 py-2.5 text-sm shadow-sm hover:bg-slate-50">
                            <i class="fa-solid fa-rotate"></i>
                            Reset
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Map -->
        <section class="mb-6">
            <div class="rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden">
                <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
                    <div class="flex items-center gap-2 text-slate-700"><i
                            class="fa-solid fa-map-location-dot text-orange-600"></i><span class="font-medium">Segments
                            Map</span></div>
                    <div class="text-sm text-slate-500" id="mapStatus">Loading map…</div>
                </div>
                <div id="map" class="w-full"></div>
            </div>
        </section>

        <!-- Results info -->
        <section class="mb-3">
            <div class="text-sm text-slate-600" id="resultsInfo">Loading leaderboards…</div>
        </section>

        <!-- Pagination Controls -->
        <section class="mb-6" id="paginationSection" style="display: none;">
            <div class="flex items-center justify-between">
                <div class="text-sm text-slate-600" id="paginationInfo">Showing 1-10 of 50 segments</div>
                <div class="flex items-center gap-2">
                    <button id="prevPageBtn"
                        class="inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fa-solid fa-chevron-left"></i>
                        Previous
                    </button>
                    <div id="pageNumbers" class="flex items-center gap-1"></div>
                    <button id="nextPageBtn"
                        class="inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        Next
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- Segments Container -->
        <section id="segmentsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4"></section>
    </main>

    <footer class="border-t border-slate-200 py-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-sm text-slate-500 flex items-center justify-between">
            <div>&copy; <span id="year"></span> Let's Roll LLC dba Chipotle Riders</div>
            <a class="inline-flex items-center gap-2 hover:text-orange-600" href="https://www.strava.com"
                target="_blank" rel="noopener">
                <i class="fa-brands fa-strava"></i> View on Strava
            </a>
        </div>
    </footer>

    <script type="module">
        const METER_TO_MILE = 0.000621371;

        const state = {
            segmentsIndex: new Map(), // strava_id -> segment meta from segments.json
            grouped: [], // array of grouped segments with leaderboard
            markersById: new Map(),
            map: null,
            markersLayer: null,
            currentPage: 1,
            itemsPerPage: 12,
            woodburyFilterActive: false,
            selectedLeaderboard: 'all' // 'all', 'KOM', or 'QOM'
        };

        const els = {
            year: document.getElementById('year'),
            searchInput: document.getElementById('searchInput'),
            komBtn: document.getElementById('komBtn'),
            qomBtn: document.getElementById('qomBtn'),
            sortSelect: document.getElementById('sortSelect'),
            resetBtn: document.getElementById('resetBtn'),
            woodburyFilterBtn: document.getElementById('woodburyFilterBtn'),
            segmentsContainer: document.getElementById('segmentsContainer'),
            resultsInfo: document.getElementById('resultsInfo'),
            mapStatus: document.getElementById('mapStatus'),
            darkModeToggle: document.getElementById('darkModeToggle'),
            map: document.getElementById('map'),
            paginationSection: document.getElementById('paginationSection'),
            paginationInfo: document.getElementById('paginationInfo'),
            prevPageBtn: document.getElementById('prevPageBtn'),
            nextPageBtn: document.getElementById('nextPageBtn'),
            pageNumbers: document.getElementById('pageNumbers')
        };

        els.year.textContent = new Date().getFullYear();

        // Simple debounce
        function debounce(fn, delay = 200) {
            let t;
            return (...args) => {
                clearTimeout(t);
                t = setTimeout(() => fn(...args), delay);
            };
        }

        function formatMiles(meters) {
            if (meters == null || Number.isNaN(meters)) return '—';
            const miles = meters * METER_TO_MILE;
            return miles.toFixed(2);
        }



        function formatTime(totalSeconds) {
            if (totalSeconds == null || !Number.isFinite(totalSeconds)) return '—';
            const seconds = Math.floor(totalSeconds % 60);
            const minutes = Math.floor((totalSeconds / 60) % 60);
            const hours = Math.floor(totalSeconds / 3600);
            const pad = (n) => String(n).padStart(2, '0');
            if (hours > 0) return `${hours}:${pad(minutes)}:${pad(seconds)}`;
            return `${minutes}:${pad(seconds)}`;
        }

        function buildSegmentsIndex(segmentsArr) {
            const map = new Map();
            for (const seg of segmentsArr) {
                if (!seg || seg.strava_id == null) continue;
                const dist = Number(seg.distance);
                const lat = Number(seg.latitude);
                const lon = Number(seg.longitude);
                map.set(String(seg.strava_id), {
                    segment_name: seg.segment_name ?? null,
                    strava_id: String(seg.strava_id),
                    distance_m: Number.isFinite(dist) ? dist : null,
                    latitude: Number.isFinite(lat) ? lat : null,
                    longitude: Number.isFinite(lon) ? lon : null
                });
            }
            return map;
        }

        function groupLeaderboardBySegment(leaderboardArr, segmentsIndex) {
            const byId = new Map();
            for (const row of leaderboardArr) {
                const stravaId = String(row.strava_id);
                if (!byId.has(stravaId)) {
                    const meta = segmentsIndex.get(stravaId) ?? null;
                    byId.set(stravaId, {
                        strava_id: stravaId,
                        segment_name: meta?.segment_name ?? row.segment_name ?? `Segment ${stravaId}`,
                        distance_m: meta?.distance_m ?? null,
                        latitude: meta?.latitude ?? null,
                        longitude: meta?.longitude ?? null,
                        entries: []
                    });
                }
                const time = Number(row.timing);
                const overallRank = Number(row.overall_rank);
                const leaderboardRank = Number(row.leaderboard_rank);
                byId.get(stravaId).entries.push({
                    person_name: row.person_name ?? 'Unknown',
                    timing: Number.isFinite(time) ? time : null,
                    overall_rank: Number.isFinite(overallRank) ? overallRank : null,
                    leaderboard_rank: Number.isFinite(leaderboardRank) ? leaderboardRank : null,
                    leaderboard: row.leaderboard ?? null
                });
            }
            const grouped = Array.from(byId.values()).map((g) => {
                // Sort by leaderboard_rank (1 = best, 2 = second best, etc.)
                g.entries.sort((a, b) => {
                    if (Number.isFinite(a.leaderboard_rank) && Number.isFinite(b.leaderboard_rank)) {
                        return a.leaderboard_rank - b.leaderboard_rank;
                    }
                    if (Number.isFinite(a.leaderboard_rank)) return -1;
                    if (Number.isFinite(b.leaderboard_rank)) return 1;
                    return 0;
                });

                g.best_time = g.entries.find((e) => Number.isFinite(e.timing))?.timing ?? null;
                g.distance_miles = Number.isFinite(g.distance_m) ? g.distance_m * METER_TO_MILE : null;
                return g;
            });
            return grouped;
        }

        function applyFiltersAndSort(groups) {
            const q = els.searchInput.value.trim().toLowerCase();
            const sort = els.sortSelect.value;

            let filtered = groups.filter((g) => {
                // Leaderboard filter: KOM, QOM, or All
                if (state.selectedLeaderboard !== 'all') {
                    const hasMatchingLeaderboard = g.entries.some((e) => e.leaderboard === state.selectedLeaderboard);
                    if (!hasMatchingLeaderboard) return false;
                }

                // Woodbury filter: only show segments where Michael Woodbury is #1 in his leaderboard
                if (state.woodburyFilterActive) {
                    const woodburyEntry = g.entries.find((e) => e.person_name === 'Michael Woodbury');
                    if (!woodburyEntry || woodburyEntry.leaderboard_rank !== 1) {
                        return false;
                    }
                }

                // Text match: segment or rider
                const matchesText = q.length === 0 ||
                    g.segment_name?.toLowerCase().includes(q) ||
                    g.entries.some((e) => e.person_name?.toLowerCase().includes(q));

                if (!matchesText) return false;
                return true;
            });

            // Sorting
            const cmp = new Intl.Collator(undefined, { sensitivity: 'base', numeric: true });
            filtered.sort((a, b) => {
                switch (sort) {
                    case 'name-asc':
                        return cmp.compare(a.segment_name ?? '', b.segment_name ?? '');
                    case 'distance-asc': {
                        const da = a.distance_miles ?? Number.POSITIVE_INFINITY;
                        const db = b.distance_miles ?? Number.POSITIVE_INFINITY;
                        return da - db;
                    }
                    case 'distance-desc': {
                        const da = a.distance_miles ?? Number.NEGATIVE_INFINITY;
                        const db = b.distance_miles ?? Number.NEGATIVE_INFINITY;
                        return db - da;
                    }
                    case 'besttime-asc': {
                        const ta = Number.isFinite(a.best_time) ? a.best_time : Number.POSITIVE_INFINITY;
                        const tb = Number.isFinite(b.best_time) ? b.best_time : Number.POSITIVE_INFINITY;
                        return ta - tb;
                    }
                    case 'leaderboard-desc':
                        return b.entries.length - a.entries.length;
                    default:
                        return 0;
                }
            });
            return filtered;
        }

        function createSegmentCard(group) {
            // Filter entries based on leaderboard selection
            let displayedEntries = group.entries;
            if (state.selectedLeaderboard !== 'all') {
                displayedEntries = group.entries.filter(entry => entry.leaderboard === state.selectedLeaderboard);
            }

            // Calculate dynamic ranks for "All Leaderboards" view
            if (state.selectedLeaderboard === 'all') {
                // Sort by timing for dynamic ranking and display order
                displayedEntries = [...displayedEntries].sort((a, b) => {
                    if (Number.isFinite(a.timing) && Number.isFinite(b.timing)) {
                        return a.timing - b.timing;
                    }
                    if (Number.isFinite(a.timing)) return -1;
                    if (Number.isFinite(b.timing)) return 1;
                    return 0;
                });

                // Assign dynamic ranks based on sorted order
                displayedEntries.forEach((entry, index) => {
                    entry.dynamicRank = Number.isFinite(entry.timing) ? index + 1 : null;
                });
            }

            const card = document.createElement('article');
            card.className = 'rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden flex flex-col';
            card.dataset.stravaId = group.strava_id;

            const header = document.createElement('div');
            header.className = 'px-4 pt-4 flex items-start justify-between gap-3';

            const titleWrap = document.createElement('div');
            titleWrap.className = 'min-w-0';

            const title = document.createElement('a');
            title.href = `https://www.strava.com/segments/${encodeURIComponent(group.strava_id)}`;
            title.target = '_blank';
            title.rel = 'noopener';
            title.className = 'group inline-flex items-center gap-2 text-base font-semibold text-slate-800 hover:text-orange-600';
            title.textContent = group.segment_name ?? `Segment ${group.strava_id}`;
            const ext = document.createElement('i');
            ext.className = 'fa-solid fa-arrow-up-right-from-square text-xs opacity-0 group-hover:opacity-100 transition-opacity';
            title.appendChild(ext);

            const meta = document.createElement('div');
            meta.className = 'mt-1 text-sm text-slate-500 flex items-center gap-3';
            const miles = document.createElement('span');
            miles.innerHTML = `<i class="fa-solid fa-ruler-horizontal text-slate-400"></i> ${group.distance_miles != null ? formatMiles(group.distance_m) : '—'} mi`;
            const best = document.createElement('span');
            best.innerHTML = `<i class="fa-solid fa-stopwatch text-slate-400"></i> Best: ${formatTime(group.best_time)}`;
            const count = document.createElement('span');
            count.innerHTML = `<i class="fa-solid fa-list-ol text-slate-400"></i> ${displayedEntries.length} entries`;
            meta.append(miles, best, count);

            titleWrap.append(title, meta);

            const mapBtn = document.createElement('button');
            mapBtn.className = 'inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm hover:bg-slate-50 disabled:opacity-50';
            mapBtn.innerHTML = '<i class="fa-solid fa-location-crosshairs"></i> View on map';
            mapBtn.disabled = !(Number.isFinite(group.latitude) && Number.isFinite(group.longitude));
            mapBtn.addEventListener('click', () => focusSegmentOnMap(group.strava_id));

            header.append(titleWrap, mapBtn);

            const tableWrap = document.createElement('div');
            tableWrap.className = 'px-4 pb-4 mt-3';
            const table = document.createElement('table');
            table.className = 'w-full text-sm';
            const thead = document.createElement('thead');
            thead.innerHTML = '<tr class="text-slate-500"><th class="text-left font-medium py-2">Rank</th><th class="text-left font-medium py-2">Rider</th><th class="text-left font-medium py-2">Time</th></tr>';
            const tbody = document.createElement('tbody');
            for (const e of displayedEntries) {
                const tr = document.createElement('tr');
                tr.className = 'border-t border-slate-100';
                const tdRank = document.createElement('td');
                const tdName = document.createElement('td');
                const tdTime = document.createElement('td');
                tdRank.className = 'py-2 pr-3 w-16 text-slate-700';
                tdName.className = 'py-2 pr-3 text-slate-800';
                tdTime.className = 'py-2 text-slate-700';

                // Use dynamic rank for "All Leaderboards", leaderboard_rank for KOM/QOM
                const rankToShow = state.selectedLeaderboard === 'all' ? e.dynamicRank : e.leaderboard_rank;
                tdRank.textContent = Number.isFinite(rankToShow) ? `#${rankToShow}` : '—';

                tdName.textContent = e.person_name ?? 'Unknown';
                tdTime.textContent = formatTime(e.timing);
                tr.append(tdRank, tdName, tdTime);
                tbody.appendChild(tr);
            }
            table.append(thead, tbody);
            tableWrap.appendChild(table);

            card.append(header, tableWrap);
            return card;
        }

        function render() {
            const filtered = applyFiltersAndSort(state.grouped);
            const totalItems = filtered.length;
            const totalPages = Math.ceil(totalItems / state.itemsPerPage);

            // Reset to first page if current page is beyond available pages
            if (state.currentPage > totalPages && totalPages > 0) {
                state.currentPage = 1;
            }

            els.resultsInfo.textContent = `${totalItems} segment${totalItems === 1 ? '' : 's'} shown`;

            // Show/hide pagination
            if (totalPages > 1) {
                els.paginationSection.style.display = 'block';
                updatePagination(totalItems, totalPages);
            } else {
                els.paginationSection.style.display = 'none';
            }

            // Calculate pagination slice
            const startIndex = (state.currentPage - 1) * state.itemsPerPage;
            const endIndex = startIndex + state.itemsPerPage;
            const paginatedItems = filtered.slice(startIndex, endIndex);

            // Update list
            els.segmentsContainer.innerHTML = '';
            const frag = document.createDocumentFragment();
            for (const group of paginatedItems) {
                frag.appendChild(createSegmentCard(group));
            }
            els.segmentsContainer.appendChild(frag);

            // Update markers to match filtered segments (all, not just current page)
            updateMarkersVisibility(new Set(filtered.map((g) => g.strava_id)));
        }

        function initMap() {
            state.map = L.map('map');
            const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap contributors'
            });
            tiles.addTo(state.map);
            state.markersLayer = L.layerGroup().addTo(state.map);
            els.mapStatus.textContent = 'Loading segments…';
        }

        function addMarkers(groups) {
            state.markersLayer.clearLayers();
            state.markersById.clear();
            const bounds = [];
            for (const g of groups) {
                if (!Number.isFinite(g.latitude) || !Number.isFinite(g.longitude)) continue;
                const marker = L.marker([g.latitude, g.longitude]);
                const popupHtml = `
            <div class="text-sm">
              <div class="font-semibold">${escapeHtml(g.segment_name ?? `Segment ${g.strava_id}`)}</div>
              <div class="text-slate-600">${g.distance_miles != null ? formatMiles(g.distance_m) : '—'} mi · Best ${formatTime(g.best_time)}</div>
              <a href="https://www.strava.com/segments/${encodeURIComponent(g.strava_id)}" target="_blank" rel="noopener" class="text-orange-600 hover:underline">Open on Strava</a>
            </div>`;
                marker.bindPopup(popupHtml);
                marker.on('click', () => scrollToSegmentCard(g.strava_id));
                marker.addTo(state.markersLayer);
                state.markersById.set(g.strava_id, marker);
                bounds.push([g.latitude, g.longitude]);
            }
            if (bounds.length > 0) {
                state.map.fitBounds(bounds, { padding: [30, 30] });
                els.mapStatus.textContent = `${bounds.length} segment${bounds.length === 1 ? '' : 's'} on map`;
            } else {
                state.map.setView([39.5, -98.35], 4); // USA fallback
                els.mapStatus.textContent = 'No mappable segments';
            }
        }

        function updateMarkersVisibility(visibleIds) {
            for (const [id, marker] of state.markersById.entries()) {
                const shouldShow = visibleIds.has(id);
                const hasLayer = state.markersLayer.hasLayer(marker);
                if (shouldShow && !hasLayer) {
                    marker.addTo(state.markersLayer);
                } else if (!shouldShow && hasLayer) {
                    state.markersLayer.removeLayer(marker);
                }
            }
        }

        function focusSegmentOnMap(stravaId) {
            const marker = state.markersById.get(String(stravaId));
            if (!marker || !state.map) return;

            // Scroll to map first
            els.map.scrollIntoView({ behavior: 'smooth', block: 'start' });

            // Center the marker with proper zoom
            const latLng = marker.getLatLng();
            state.map.setView(latLng, 16, { animate: true });

            // Open popup after a short delay to ensure map is centered
            setTimeout(() => {
                marker.openPopup();
            }, 500);
        }

        function scrollToSegmentCard(stravaId) {
            const card = els.segmentsContainer.querySelector(`[data-strava-id="${CSS.escape(String(stravaId))}"]`);
            if (!card) return;
            card.scrollIntoView({ behavior: 'smooth', block: 'start' });
            card.classList.add('ring', 'ring-orange-500');
            setTimeout(() => card.classList.remove('ring', 'ring-orange-500'), 1200);
        }

        function updatePagination(totalItems, totalPages) {
            const startItem = (state.currentPage - 1) * state.itemsPerPage + 1;
            const endItem = Math.min(state.currentPage * state.itemsPerPage, totalItems);

            els.paginationInfo.textContent = `Showing ${startItem}-${endItem} of ${totalItems} segments`;

            // Update prev/next buttons
            els.prevPageBtn.disabled = state.currentPage === 1;
            els.nextPageBtn.disabled = state.currentPage === totalPages;

            // Generate page numbers
            els.pageNumbers.innerHTML = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, state.currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            // Adjust start if we're near the end
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            // Add page numbers
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `inline-flex items-center justify-center w-8 h-8 rounded-lg text-sm font-medium ${i === state.currentPage
                    ? 'bg-orange-500 text-white'
                    : 'border border-slate-300 bg-white text-slate-700 hover:bg-slate-50'
                    }`;
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => {
                    state.currentPage = i;
                    render();
                });
                els.pageNumbers.appendChild(pageBtn);
            }
        }

        function updateLeaderboardButtons() {
            // Reset both buttons to default state
            [els.komBtn, els.qomBtn].forEach(btn => {
                btn.classList.remove('bg-orange-500', 'text-white', 'border-orange-500');
                btn.classList.add('border-slate-300', 'bg-white', 'text-slate-700');
            });

            // Set active button
            if (state.selectedLeaderboard === 'KOM') {
                els.komBtn.classList.add('bg-orange-500', 'text-white', 'border-orange-500');
                els.komBtn.classList.remove('border-slate-300', 'bg-white', 'text-slate-700');
            } else if (state.selectedLeaderboard === 'QOM') {
                els.qomBtn.classList.add('bg-orange-500', 'text-white', 'border-orange-500');
                els.qomBtn.classList.remove('border-slate-300', 'bg-white', 'text-slate-700');
            }
        }

        function updateWoodburyButton() {
            if (state.woodburyFilterActive) {
                els.woodburyFilterBtn.classList.add('bg-orange-500', 'text-white', 'border-orange-500');
                els.woodburyFilterBtn.classList.remove('border-slate-300', 'bg-white', 'text-slate-700');
            } else {
                els.woodburyFilterBtn.classList.remove('bg-orange-500', 'text-white', 'border-orange-500');
                els.woodburyFilterBtn.classList.add('border-slate-300', 'bg-white', 'text-slate-700');
            }
        }

        function escapeHtml(str) {
            return String(str)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        async function loadData() {
            els.resultsInfo.textContent = 'Loading data…';
            const [segmentsResp, leaderboardResp] = await Promise.all([
                fetch(document.location.protocol === 'file:' ? 'https://woodburyshitlist.jordanjudt.com/segments.json' : './segments.json'),
                fetch(document.location.protocol === 'file:' ? 'https://woodburyshitlist.jordanjudt.com/komqom.json' : './komqom.json')
            ]);

            if (!segmentsResp.ok) throw new Error(`Failed to load segments.json (${segmentsResp.status})`);
            if (!leaderboardResp.ok) throw new Error(`Failed to load komqom.json (${leaderboardResp.status})`);

            const [segmentsArr, leaderboardArr] = await Promise.all([
                segmentsResp.json(),
                leaderboardResp.json()
            ]);

            state.segmentsIndex = buildSegmentsIndex(segmentsArr);
            state.grouped = groupLeaderboardBySegment(leaderboardArr, state.segmentsIndex);

            addMarkers(state.grouped);
            render();
        }

        function attachEvents() {
            els.searchInput.addEventListener('input', debounce(() => {
                state.currentPage = 1; // Reset to first page on search
                render();
            }, 200));
            els.komBtn.addEventListener('click', () => {
                if (state.selectedLeaderboard === 'KOM') {
                    state.selectedLeaderboard = 'all'; // Toggle off if already selected
                } else {
                    state.selectedLeaderboard = 'KOM';
                }
                state.currentPage = 1;
                updateLeaderboardButtons();
                render();
            });

            els.qomBtn.addEventListener('click', () => {
                if (state.selectedLeaderboard === 'QOM') {
                    state.selectedLeaderboard = 'all'; // Toggle off if already selected
                } else {
                    state.selectedLeaderboard = 'QOM';
                }
                state.currentPage = 1;
                updateLeaderboardButtons();
                render();
            });
            els.sortSelect.addEventListener('change', () => {
                state.currentPage = 1; // Reset to first page on sort
                render();
            });
            els.woodburyFilterBtn.addEventListener('click', () => {
                state.woodburyFilterActive = !state.woodburyFilterActive;
                state.currentPage = 1;
                updateWoodburyButton();
                render();
            });

            els.resetBtn.addEventListener('click', () => {
                els.searchInput.value = '';
                state.selectedLeaderboard = 'all';
                els.sortSelect.value = 'name-asc';
                state.woodburyFilterActive = false;
                state.currentPage = 1;
                updateLeaderboardButtons();
                updateWoodburyButton();
                render();
            });

            // Pagination events
            els.prevPageBtn.addEventListener('click', () => {
                if (state.currentPage > 1) {
                    state.currentPage--;
                    render();
                }
            });
            els.nextPageBtn.addEventListener('click', () => {
                const filtered = applyFiltersAndSort(state.grouped);
                const totalPages = Math.ceil(filtered.length / state.itemsPerPage);
                if (state.currentPage < totalPages) {
                    state.currentPage++;
                    render();
                }
            });

            // Dark mode toggle
            els.darkModeToggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                const isDark = document.documentElement.classList.contains('dark');
                localStorage.setItem('darkMode', isDark);
            });

            // Initialize dark mode from localStorage
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode === 'true') {
                document.documentElement.classList.add('dark');
            }
        }

        // Initialize
        initMap();
        attachEvents();
        loadData().catch((err) => {
            console.error(err);
            els.resultsInfo.innerHTML = `<span class="text-red-600"><i class=\"fa-solid fa-triangle-exclamation\"></i> ${escapeHtml(err.message)}</span>`;
            els.mapStatus.innerHTML = `<span class="text-red-600"><i class=\"fa-solid fa-triangle-exclamation\"></i> Map may be incomplete</span>`;
        });
    </script>
</body>

</html>